<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RMA Web Form</title>

    <style>
      /* ===== RESET & GLOBAL ===== */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      /* ===== PAGE BACKGROUND ===== */
      body {
        margin: 0;
        font-family: Arial, Helvetica, sans-serif;
        color: #0a2a43;
        font-size: clamp(11px, 2.5vw, 13px);
        position: relative;
        z-index: 0;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image: url("https://i.ibb.co/hJfMMh17/image-2.png");
        opacity: 0.25;
        background-repeat: no-repeat;
        background-position: top center;
        background-size: 100% 100%;
        z-index: -1;
      }

      /* ===== HEADER ===== */
      .header {
        text-align: center;
        padding: 40px 20px 20px;
      }

      .header img {
        max-width: 220px;
      }

      .header h2 {
        margin: 16px 0 6px;
        color: #1f3c6d;
        font-size: 22px;
      }

      .header p {
        margin: 0;
        font-size: 14px;
        font-style: italic;
        color: #444;
      }

      /* ===== CARD ===== */
      .container {
        max-width: 760px;
        margin: 20px auto 50px;
        background: #ffffff;
        border-radius: 14px;
        padding: 34px 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
      }

      .title {
        text-align: center;
        font-size: 26px;
        color: #355c9a;
        font-weight: 650;
        margin-bottom: 30px;
      }

      /* ===== FORM SECTIONS ===== */
      .form-section {
        margin-bottom: 28px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e6f0;
      }

      .form-section:last-of-type {
        border-bottom: none;
        margin-bottom: 20px;
      }

      .section-title {
        font-size: 17px;
        color: #1f3c6d;
        font-weight: 600;
        margin-bottom: 18px;
        padding-bottom: 6px;
        border-bottom: 2px solid #355c9a;

        display: flex;
        align-items: center;
      }

      .section-title::before {
        content: "";
        display: inline-block;
        width: 6px;
        height: 18px;
        background-color: #355c9a;
        margin-right: 10px;
        border-radius: 1px;
      }

      /* ===== FORM GRID ===== */
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        column-gap: 36px;
        row-gap: 18px;
      }

      .field {
        display: flex;
        flex-direction: column;
      }

      .field label {
        font-size: 13px;
        color: #333;
        margin-bottom: 6px;
        font-weight: bolder;
      }

      .required::after {
        content: " *";
        color: #d93025;
      }

      /* ===== INPUTS ===== */
      .field input,
      .field select,
      .field textarea {
        height: 35px;
        padding: 0px 12px;
        font-size: 14px;
        border-radius: 5px;
        border: 1px solid #d0d7e5;
        background: #f8fafc;
        outline: none;
        font-family: Arial, Helvetica, sans-serif;
        transition: all 0.2s ease;
      }

      .field input:focus,
      .field select:focus,
      .field textarea:focus {
        border-color: #355c9a;
        background: #ffffff;
        box-shadow: 0 0 0 2px rgba(53, 92, 154, 0.1);
      }

      /* Date input specific styling */
      .field input[type="date"] {
        padding: 0px 10px;
      }

      /* Placeholder styling for date inputs */
      .field input[type="date"]:not(:valid):not(:focus) {
        color: #999;
      }

      .field input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
        opacity: 0.7;
      }

      .field textarea {
        padding: 10px 12px;
        height: 80px !important;
        resize: vertical;
        min-height: 80px;
        line-height: 1.4;
      }

      input[readonly] {
        background: #edf1f7;
        cursor: not-allowed;
        border-color: #c8d1e0;
      }

      .full {
        grid-column: span 2;
      }

      /* ===== DISCLAIMER ===== */
      .disclaimer {
        margin-top: 28px;
        font-size: 12.8px;
        color: #222;
        line-height: 1.55;
        padding: 16px;
        background: #f8fafc;
        border-radius: 6px;
        border-left: 4px solid #355c9a;
      }

      .disclaimer strong {
        display: block;
        margin-bottom: 6px;
        color: #1f3c6d;
      }

      .disclaimer a {
        color: #1f3c6d;
        text-decoration: underline;
        font-weight: 600;
      }

      .disclaimer a:hover {
        color: #2a4c85;
      }

      /* ===== SUBMIT ===== */
      .submit-wrap {
        text-align: center;
        margin-top: 28px;
      }

      .submit-wrap button {
        background: #355c9a;
        color: #fff;
        border: none;
        padding: 12px 46px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 3px 8px rgba(53, 92, 154, 0.2);
      }

      .submit-wrap button:hover {
        background: #2a4c85;
        transform: translateY(-1px);
        box-shadow: 0 5px 12px rgba(53, 92, 154, 0.3);
      }

      .submit-wrap button:active {
        transform: translateY(0);
      }

      .submit-wrap button:disabled {
        background: #cccccc;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      /* ===== MOBILE ===== */
      @media (max-width: 768px) {
        .container {
          padding: 26px 22px;
        }
        .form-grid {
          grid-template-columns: 1fr;
        }
        .full {
          grid-column: span 1;
        }
        .section-title {
          font-size: 16px;
        }
      }

      /* Modal Styles */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 42, 67, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.show {
        display: flex;
      }

      .modal-content {
        background: #ffffff;
        border-radius: 12px;
        padding: 28px 32px;
        max-width: 420px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        text-align: center;
        animation: modalSlideIn 0.3s ease-out;
      }

      .modal-content.image-only {
        background: transparent;
        padding: 0;
        max-width: none;
        width: auto;
        box-shadow: none;
      }

      @keyframes modalSlideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }

      .modal-icon.success {
        color: #28a745;
      }

      .modal-icon.error {
        color: #dc3545;
      }

      .modal-image {
        max-width: 100%;
        height: auto;
        margin-bottom: 16px;
      }

      .modal-full-image {
        max-width: 90%;
        width: auto;
        height: auto;
        cursor: pointer;
        border-radius: 12px;
      }

      .modal-title {
        font-size: clamp(18px, 4vw, 18px);
        font-weight: 300;
        color: #0a2a43;
        margin-bottom: 12px;
      }

      .modal-message {
        font-size: clamp(13px, 3vw, 15px);
        color: #333;
        line-height: 1.5;
        margin-bottom: 24px;
      }

      .modal-btn {
        background: #2f5fa7;
        color: #ffffff;
        padding: 10px 32px;
        border-radius: 6px;
        border: none;
        font-size: clamp(13px, 3vw, 15px);
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }

      .modal-btn:hover {
        background: #264a85;
      }

      .help-text {
        font-size: clamp(10px, 2.4vw, 11.5px);
        color: #666;
        font-style: italic;
        margin-top: 4px;
      }

      /* Loading Modal Styles */
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 42, 67, 0.85);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }

      .loading-overlay.show {
        display: flex;
      }

      .loading-content {
        background: #ffffff;
        border-radius: 12px;
        padding: 32px 36px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        text-align: center;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        margin: 0 auto 20px;
        border: 4px solid #e3f2fd;
        border-top: 4px solid #2f5fa7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        font-size: clamp(14px, 3.2vw, 16px);
        font-weight: 600;
        color: #0a2a43;
        margin-bottom: 20px;
      }

      .progress-steps {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 20px 0;
      }

      .progress-step-image {
        max-height: 50px;
        width: auto;
      }

      .progress-separator {
        max-height: 20px;
        width: auto;
        margin: 0 10px;
      }

      .progress-container {
        width: 100%;
        height: 8px;
        background: #e3f2fd;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 12px;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #2f5fa7, #4a7bc8);
        border-radius: 4px;
        transition: width 0.3s ease;
        box-shadow: 0 0 10px rgba(47, 95, 167, 0.5);
      }

      .progress-label {
        font-size: clamp(11px, 2.6vw, 13px);
        color: #666;
      }

      /* File upload styling */
      .file-input-wrapper {
        margin-top: 5px;
      }

      .file-input-wrapper input[type="file"] {
        padding: 8px;
        background: #f2f5f9;
        border-radius: 4px;
        width: 100%;
      }

      /* ===== FILE UPLOAD WITH PREVIEW ===== */
      .upload-box {
        position: relative;
        width: 100%;
        min-height: 160px;
        background: #f3f6fb;
        border: 2px dashed #c7d6ff;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.25s ease;
        padding: 20px;
      }

      .upload-box:hover {
        background: #eef3ff;
        border-color: #355c9a;
      }

      .upload-box.error {
        border-color: #dc3545;
        background: #fff5f5;
        animation: shake 0.5s ease-in-out;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
          transform: translateX(-5px);
        }
        20%,
        40%,
        60%,
        80% {
          transform: translateX(5px);
        }
      }

      .upload-content {
        text-align: center;
        color: #444;
      }

      .upload-text {
        font-size: 16px;
        font-weight: 500;
        margin: 10px 0 5px;
      }

      .upload-subtext {
        font-size: 12px;
        color: #666;
      }

      /* hide real input */
      .upload-input {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }

      /* Validation message */
      .validation-message {
        animation: fadeIn 0.3s ease;
        padding: 8px 12px;
        background: #fff5f5;
        border-radius: 4px;
        border-left: 3px solid #dc3545;
        color: #dc3545;
        font-size: 12px;
      }

      /* File list styles */
      .file-list-container {
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        margin-bottom: 8px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        transition: all 0.2s ease;
      }

      .file-item:hover {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        border-color: #c7d6ff;
      }

      .file-item.error {
        border-color: #dc3545;
        background: #fff5f5;
      }

      .file-info {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        min-width: 0;
      }

      .file-icon {
        font-size: 20px;
        color: #355c9a;
        flex-shrink: 0;
      }

      .file-icon.error {
        color: #dc3545;
      }

      .file-name {
        font-size: 13px;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
      }

      .file-name.error {
        color: #dc3545;
      }

      .file-size {
        font-size: 11.5px;
        color: #666;
        white-space: nowrap;
        flex-shrink: 0;
        margin-left: 8px;
      }

      .file-size.error {
        color: #dc3545;
        font-weight: 600;
      }

      .remove-file {
        background: #ff4444;
        color: white;
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        flex-shrink: 0;
        transition: background 0.2s ease;
        margin-left: 8px;
      }

      .remove-file:hover {
        background: #cc0000;
      }

      /* Summary styles */
      .file-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: #f0f4f9;
        border-radius: 6px;
        margin-top: 12px;
        font-size: 12px;
        border: 1px solid #e0e0e0;
      }

      .total-size {
        color: #333;
        font-weight: 600;
      }

      .total-count {
        color: #355c9a;
        font-weight: 600;
      }

      /* Drag & drop feedback */
      .upload-box.drag-over {
        border-color: #355c9a;
        background: #eef3ff;
        transform: scale(1.01);
      }
      
      label{
          font-weight: bolder ;
      }
    </style>
  </head>

  <body>
    <!-- HEADER -->
    <div class="header">
      <img src="https://i.ibb.co/vvwrFWQ9/image.png" alt="CRS Jet Spares" />
      <h2>Parts. Problems. Solved</h2>
      <p>We offer More than just Parts. We offer Solutions.</p>
    </div>

    <!-- FORM CARD -->
    <div class="container">
      <div class="title">
          RMA Web Form
          <div style="font-size :14px; color:black; font-weight:500; margin-top : 10px;" >
              ‚ÄúCRS will not accept any parts w/o approval and RMA# provided‚Äù 
          </div>
      </div>

      <form id="rmaForm" novalidate>
        <!-- SECTION 1: REQUESTER INFO -->
        <div class="form-section">
          <div class="section-title">Requester Info</div>
          <div class="form-grid">
            <!-- RMA REQUEST TYPE -->
            <div class="field">
              <label class="required">RMA Request Type</label>
              <select name="rmaRequestType" required>
                <option value="Warranty Replacement">Warranty Replacement</option>
                <option value="Warranty C.P.O">Warranty C.P.O</option>
                <option value="Return for Credit">Return for Credit</option>
                <option value="Warranty Return for Credit">
                  Warranty Return for Credit
                </option>
              </select>
            </div>

            <!-- CONTACT NAME -->
            <div class="field">
              <label class="required">Name</label>
              <input name="contactName" required />
            </div>
            <!-- COMPANY NAME -->
            <div class="field">
              <label class="required">Company Name</label>
              <input name="companyName" required />
            </div>

            <!-- EMAIL -->
            <div class="field">
              <label class="required">Email</label>
              <input name="email" type="email" required />
            </div>
            
            
            <!-- CUSTOMER NUMBER -->
            <div class="field">
              <label>Customer #</label>
              <input name="customerNumber" />
            </div>

            



            <!-- PHONE -->
            <div class="field">
              <label class="required">Phone</label>
              <input name="phone" required />
            </div>
          </div>
        </div>

        <!-- SECTION 2: ORDER INFO -->
        <div class="form-section">
          <div class="section-title">Order Info <span style="font-size: 12px; font-weight: 400; color: #d93025; font-style: italic;">(SO # / Customer PO # are required)</span></div>
          <div class="form-grid">
            <!-- SALES ORDER -->
            <div class="field">
              <label class="required">SO #</label>
              <input name="salesOrderNumber" placeholder="SO-xxxxx" />
            </div>

            <!-- ORIGINAL TRANSACTION DATE -->
            <div class="field">
              <label>Original Transaction Date</label>
              <input
                name="originalTransactionDate"
                id="originalTransactionDate"
                type="date"
              />
            </div>
            
            <!-- CUSTOMER PO -->
            <div class="field">
              <label class="required">Customer PO #</label>
              <input name="customerPoNumber" />
            </div>

            <!-- ORIGINAL INVOICE -->
            <div class="field">
              <label>Original Invoice #</label>
              <input name="originalInvoiceNumber" />
            </div>
          </div>
        </div>

        <!-- SECTION 3: PART INFO -->
        <div class="form-section">
          <div class="section-title">Part Info</div>
          <div class="form-grid">
              
              <!-- PART NUMBER -->
            <div class="field">
              <label class="required">Part Number (PN)</label>
              <input name="partNumber" required />
            </div>
            
            <!-- AIRCRAFT TYPE -->
            <div class="field">
              <label class="required">Aircraft Type</label>
              <input name="aircraftType" required />
            </div>

            <!-- SERIAL NUMBER -->
            <div class="field">
              <label class="required">Serial Number (SN)</label>
              <input name="serialNumber" required />
            </div>
              


            <!-- AIRCRAFT SERIAL -->
            <div class="field">
              <label class="required">Aircraft Serial #</label>
              <input name="aircraftSerialNumber" required />
            </div>
            

            <!-- INSTALL DATE -->
            <div class="field">
              <label class="required">Install Date</label>
              <input name="installDate" id="installDate" type="date" required />
            </div>

            <!-- TOTAL TIME -->
            <div class="field">
              <label class="required">Total Time Since Install (Days)</label>
              <input
                name="totalTimeSinceInstall"
                id="totalTimeSinceInstall"
                readonly
              />
            </div>

            <!-- REMOVAL DATE -->
            <div class="field">
              <label>Removal Date</label>
              <input name="removalDate" id="removalDate" type="date" />
            </div>

            <!-- TOTAL CYCLES -->
            <div class="field">
              <label>Total Cycles Since Install</label>
              <input
                name="totalCyclesSinceInstall"
                id="totalCyclesSinceInstall"
                readonly
              />
            </div>
            
            <!-- DISCREPANCY -->
            <div class="field full">
              <label class="required">Discrepancy</label>
              <textarea name="discrepancy" style="resize:none;" required></textarea>
            </div>
          </div>
        </div>



        <!-- SECTION 6: FILE ATTACHMENTS -->
        <div class="form-section">
          <div class="section-title">File Attachments</div>
          <div class="form-grid">
            <div class="field full">
              <label>Attach Files (Optional)</label>

              <!-- Upload Box Design -->
              <label class="upload-box" style="margin-top: 5px">
                <input
                  id="fileAttachment"
                  class="upload-input"
                  type="file"
                  multiple
                />

                <div class="upload-content" id="uploadContent">
                  <svg viewBox="0 0 24 24" style="width: 48px; height: 48px">
                    <path
                      d="M5 20h14a1 1 0 0 0 1-1v-4h-2v3H6v-3H4v4a1 1 0 0 0 1 1z"
                    />
                    <path d="M11 16h2V8h3l-4-4-4 4h3z" />
                  </svg>
                  <div class="upload-text">Click to upload files</div>
                  <div class="upload-subtext">Max 33 files, total size: 5MB</div>
                </div>
              </label>

              <!-- Validation message -->
              <div
                id="fileValidation"
                class="validation-message"
                style="display: none; margin-top: 5px"
              ></div>

              <!-- Selected files display -->
              <div
                id="fileList"
                class="file-list-container"
                style="display: none; margin-top: 10px"
              >
                <div
                  style="
                    font-size: 13px;
                    font-weight: 600;
                    color: #444;
                    margin-bottom: 8px;
                  "
                >
                  Selected Files:
                </div>
                <div
                  id="selectedFiles"
                  style="
                    max-height: 200px;
                    overflow-y: auto;
                    border: 1px solid #e0e0e0;
                    border-radius: 6px;
                    padding: 12px;
                    background: #f9f9f9;
                  "
                >
                  <!-- Files will be listed here -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- TERMS -->
        <div class="disclaimer full">
          <strong>Disclaimer</strong>
          <ol>
              <li>
                  CRS Jet Spares will not accept and units returned without a RMA Authorization Number.
              </li>
              <li>
                  
                All units must be returned within 7 days and accompanied with the original paperwork. Failure to do so may result in warranty denial.
              </li>
                <li>
                    In the event of a no fault found or that failure is a result of improper use, customer will be responsible foy any charges incurred. CRS is not liable for any consequential expenses related to the warranty claim.
                </li>
                <li>
                    A minimum 20% restocking fee applies on all returns. Any returns where packing has been opened recertification charged will also apply.¬†
                </li>
          </ol>
          
          <div>
              I hereby affirm all information regarding the above mentioned components including total time, if any and cycles to be true and correct. By submitting the information in the RMA Request form, you are agreeing to the  listed on the 
              <a
            href="https://crsjetspares.com/general-terms-and-conditions-for-sale-and-exchange-of-goods/"
            target="_blank">
            Terms and Conditions </a
          >.CRS Jet Spares invoice and website.
          </div>
        </div>

        <div class="submit-wrap">
          <button type="submit" id="submitBtn">Submit</button>
        </div>
      </form>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="loading-overlay">
      <div class="loading-content">
        <div id="loadingText" class="loading-text">Processing...</div>
        <div class="progress-steps">
          <img id="verifyingIcon" src="assets/VerifyingSalesOrder.png" class="progress-step-image" alt="Verifying" />
          <img id="separator" src="assets/SeparatorGrey.png" class="progress-separator" alt="Separator" />
          <img id="preparingIcon" src="assets/PreparingSubmissionGrey.png" class="progress-step-image" alt="Preparing" />
        </div>
      </div>
    </div>

    <!-- Modal Popup -->
    <div id="modal" class="modal-overlay">
      <div class="modal-content">
        <div id="modalIcon" class="modal-icon"></div>
        <div id="modalTitle" class="modal-title"></div>
        <div id="modalMessage" class="modal-message"></div>
        <button class="modal-btn" onclick="closeModal()">OK</button>
      </div>
    </div>

    <script>
      // ================= CONFIGURATION =================
      const CLIENT_ID =
        "3MVG9O_Hkc8TP1aFEeEWU9ZyX2f05bkHPl2XawuPFSJwal8ZF1mDPue9o0kPDBVcOU64PRCCEZnQq2aIJmKv5";
      const CLIENT_SECRET =
        "4DA156C1380C7AA53FCE2C408620F764D3D46C7C4453D58077B173206EA351C5";
      const SF_INSTANCE =
        "https://prod-avs-crsjetspares--crsdev25.sandbox.my.salesforce.com";
      const OAUTH_URL = SF_INSTANCE + "/services/oauth2/token";
      const API_ENDPOINT = SF_INSTANCE + "/services/apexrest/caseManagement/";

      // ================= FILE VALIDATION CONSTANTS =================
      let MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB in bytes (default)
      const MAX_FILE_COUNT = 33;
      let ALLOWED_FILE_FORMATS = []; // Will be populated from metadata
      let fileSettingsLoaded = false;

      // ================= GET ATTACHMENT VALIDATIONS =================
      async function fetchFileSettings() {
        try {
          const accessToken = await getAccessToken();

          // Query custom metadata for RMASetting
          const query = "SELECT File_Formats__c, Maximum_Size__c FROM FilesAttachmentSettings__mdt WHERE DeveloperName='RMASetting' LIMIT 1";
          const url = SF_INSTANCE + '/services/data/v62.0/query?q=' + encodeURIComponent(query);

          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Authorization': 'Bearer ' + accessToken,
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            console.error('Failed to fetch file settings from metadata');
            return false;
          }

          const data = await response.json();

          if (data.records && data.records.length > 0) {
            const settings = data.records[0];

            // Parse file formats (comma-separated)
            if (settings.File_Formats__c) {
              ALLOWED_FILE_FORMATS = settings.File_Formats__c
                .split(',')
                .map(format => format.trim().toLowerCase())
                .filter(format => format.length > 0);
            }

            // Parse maximum size (in MB)
            if (settings.Maximum_Size__c) {
              MAX_FILE_SIZE = parseFloat(settings.Maximum_Size__c) * 1024 * 1024; // Convert MB to bytes
            }

            fileSettingsLoaded = true;

            // Update the file label with allowed formats and max size
            updateFileLabel();

            // Update the upload subtext with dynamic values
            updateUploadSubtext();

            // Update the file input accept attribute
            updateFileInputAccept();

            return true;
          }

          return false;
        } catch (error) {
          console.error('Error fetching file settings:', error);
          return false;
        }
      }

      function updateFileLabel() {
        const labels = document.querySelectorAll('.field label');
        for (let i = 0; i < labels.length; i++) {
          if (labels[i].textContent.includes('Attach Files')) {
            updateLabelText(labels[i]);
            return;
          }
        }
      }

      function updateLabelText(label) {
        if (ALLOWED_FILE_FORMATS.length > 0) {
          const maxSizeMB = (MAX_FILE_SIZE / (1024 * 1024)).toFixed(1);
          const formatsText = ALLOWED_FILE_FORMATS.join(', ').toUpperCase();
          label.innerHTML = `Attach Files (Optional) <span style="color: #666; font-weight: 400; font-size: 11px;">(Allowed formats: ${formatsText}, Max total size: ${maxSizeMB}MB)</span>`;
        }
      }

      function updateUploadSubtext() {
        const uploadSubtext = document.querySelector('.upload-subtext');
        if (uploadSubtext && fileSettingsLoaded) {
          const maxSizeMB = (MAX_FILE_SIZE / (1024 * 1024)).toFixed(1);
          uploadSubtext.textContent = `Max ${MAX_FILE_COUNT} files, total size: ${maxSizeMB}MB`;
        }
      }

      function updateFileInputAccept() {
        const fileInput = document.getElementById('fileAttachment');
        if (fileInput && ALLOWED_FILE_FORMATS.length > 0) {
          // Create accept attribute with dot prefix for each format
          fileInput.setAttribute('accept', ALLOWED_FILE_FORMATS.map(format => '.' + format).join(','));
        }
      }

      // Track files separately from the input
      let allSelectedFiles = [];

      // ================= FILE UTILITY FUNCTIONS =================
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function getFileIcon(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        const icons = {
          pdf: "üìÑ",
          doc: "üìù",
          docx: "üìù",
          txt: "üìÉ",
          jpg: "üñºÔ∏è",
          jpeg: "üñºÔ∏è",
          png: "üñºÔ∏è",
          gif: "üñºÔ∏è",
          bmp: "üñºÔ∏è",
          tiff: "üñºÔ∏è",
          svg: "üñºÔ∏è",
          xls: "üìä",
          xlsx: "üìä",
          zip: "üì¶",
          rar: "üì¶",
          "7z": "üì¶",
          xml: "üìã",
          csv: "üìä",
          json: "üìã",
          log: "üìã",
          ppt: "üìä",
          pptx: "üìä",
        };

        return icons[ext] || "üìé";
      }

      // Function to get file extension
      function getFileExtension(filename) {
        return filename.split('.').pop().toLowerCase();
      }

      function validateFiles(files) {
        const validation = {
          valid: true,
          errors: [],
          invalidFormatFiles: [],
          totalSize: 0,
          validFiles: []
        };

        // Check file count
        if (files.length > MAX_FILE_COUNT) {
          validation.valid = false;
          validation.errors.push(
            `Maximum ${MAX_FILE_COUNT} files allowed. You selected ${files.length} files.`
          );
        }

        // Check each file for format and calculate total size
        Array.from(files).forEach((file, index) => {
          let fileIsValid = true;

          // Check file format if settings are loaded
          if (fileSettingsLoaded && ALLOWED_FILE_FORMATS.length > 0) {
            const fileExt = getFileExtension(file.name);
            if (!ALLOWED_FILE_FORMATS.includes(fileExt)) {
              validation.valid = false;
              fileIsValid = false;
              validation.invalidFormatFiles.push({
                name: file.name,
                extension: fileExt,
                index: index
              });
              validation.errors.push(`"${file.name}" has invalid format. Allowed formats: ${ALLOWED_FILE_FORMATS.join(', ')}`);
            }
          }

          // Add to valid files and calculate total size
          if (fileIsValid) {
            validation.validFiles.push(file);
            validation.totalSize += file.size;
          }
        });

        // Check total size of all files combined
        if (fileSettingsLoaded && validation.totalSize > MAX_FILE_SIZE) {
          validation.valid = false;
          validation.errors.push(`Total file size (${formatFileSize(validation.totalSize)}) exceeds maximum allowed (${formatFileSize(MAX_FILE_SIZE)})`);
        }

        return validation;
      }

      function showFileValidationError(message) {
        const validationDiv = document.getElementById("fileValidation");
        const uploadBox = document.querySelector(".upload-box");

        validationDiv.textContent = message;
        validationDiv.style.display = "block";
        uploadBox.classList.add("error");

        // Remove error state after 5 seconds
        setTimeout(() => {
          validationDiv.style.display = "none";
          uploadBox.classList.remove("error");
        }, 5000);
      }

      function updateFileInputWithAllFiles() {
        const fileInput = document.getElementById("fileAttachment");
        const dataTransfer = new DataTransfer();

        // Add all tracked files to DataTransfer
        allSelectedFiles.forEach((file) => {
          dataTransfer.items.add(file);
        });

        // Update the file input
        fileInput.files = dataTransfer.files;
      }

      function displaySelectedFiles() {
        const fileListContainer = document.getElementById("fileList");
        const selectedFilesDiv = document.getElementById("selectedFiles");
        const uploadContent = document.getElementById("uploadContent");
        const validationDiv = document.getElementById("fileValidation");
        const uploadBox = document.querySelector(".upload-box");

        // Clear validation first
        validationDiv.style.display = "none";
        uploadBox.classList.remove("error");

        if (allSelectedFiles.length > 0) {
          // Calculate total size and check for validation errors
          let totalSize = 0;
          allSelectedFiles.forEach(file => totalSize += file.size);

          // Check if total size exceeds limit
          if (fileSettingsLoaded && totalSize > MAX_FILE_SIZE) {
            showFileValidationError(
              `Total file size (${formatFileSize(totalSize)}) exceeds maximum allowed (${formatFileSize(MAX_FILE_SIZE)})`
            );
          }

          // Update upload box appearance
          uploadContent.innerHTML = `
              <svg viewBox="0 0 24 24" style="width: 48px; height: 48px;">
                  <path d="M5 20h14a1 1 0 0 0 1-1v-4h-2v3H6v-3H4v4a1 1 0 0 0 1 1z"/>
                  <path d="M11 16h2V8h3l-4-4-4 4h3z"/>
              </svg>
              <div class="upload-text">
                  ${allSelectedFiles.length} file${
            allSelectedFiles.length > 1 ? "s" : ""
          } selected
              </div>
              <div class="upload-subtext">
                  Click to add more files
              </div>
          `;

          // Display files list
          selectedFilesDiv.innerHTML = "";

          allSelectedFiles.forEach((file, index) => {
            const fileExtension = getFileExtension(file.name);
            const isValidFormat =
              !fileSettingsLoaded ||
              ALLOWED_FILE_FORMATS.length === 0 ||
              ALLOWED_FILE_FORMATS.includes(fileExtension);

            const isInvalid = !isValidFormat;

            let errorMessage = '';
            if (!isValidFormat) {
              errorMessage = ' (Invalid format!)';
            }

            const fileItem = document.createElement("div");
            fileItem.className = `file-item ${isInvalid ? "error" : ""}`;
            fileItem.innerHTML = `
                  <div class="file-info">
                      <span class="file-icon ${
                        isInvalid ? "error" : ""
                      }">${getFileIcon(file.name)}</span>
                      <span class="file-name ${
                        isInvalid ? "error" : ""
                      }" title="${file.name}">${file.name}</span>
                      <span class="file-size ${isInvalid ? "error" : ""}">
                          ${formatFileSize(file.size)}${errorMessage}
                      </span>
                  </div>
                  <button type="button" class="remove-file" data-index="${index}">√ó</button>
              `;
            selectedFilesDiv.appendChild(fileItem);
          });

          // Add summary
          const summaryDiv = document.createElement("div");
          summaryDiv.className = "file-summary";
          const totalSizeExceeded = fileSettingsLoaded && totalSize > MAX_FILE_SIZE;
          summaryDiv.innerHTML = `
              <div class="total-count">${allSelectedFiles.length} of ${MAX_FILE_COUNT} files</div>
              <div class="total-size" style="${totalSizeExceeded ? 'color: #dc3545; font-weight: 700;' : ''}">
                  Total: ${formatFileSize(totalSize)}${totalSizeExceeded ? ' (Exceeds limit!)' : ''}
                  ${fileSettingsLoaded ? ' / ' + formatFileSize(MAX_FILE_SIZE) : ''}
              </div>
          `;
          selectedFilesDiv.appendChild(summaryDiv);

          fileListContainer.style.display = "block";

          // Add event listeners to remove buttons
          selectedFilesDiv.querySelectorAll(".remove-file").forEach((button) => {
            button.addEventListener("click", function (e) {
              e.stopPropagation();
              const index = parseInt(this.getAttribute("data-index"));
              removeFile(index);
            });
          });
        } else {
          // Reset upload box to default
          const maxSizeMB = (MAX_FILE_SIZE / (1024 * 1024)).toFixed(1);

          uploadContent.innerHTML = `
              <svg viewBox="0 0 24 24" style="width: 48px; height: 48px;">
                  <path d="M5 20h14a1 1 0 0 0 1-1v-4h-2v3H6v-3H4v4a1 1 0 0 0 1 1z"/>
                  <path d="M11 16h2V8h3l-4-4-4 4h3z"/>
              </svg>
              <div class="upload-text">
                  Click to upload files
              </div>
              <div class="upload-subtext">
                  Max ${MAX_FILE_COUNT} files, total size: ${maxSizeMB}MB
              </div>
          `;
          fileListContainer.style.display = "none";
        }
      }

      function removeFile(index) {
        if (index >= 0 && index < allSelectedFiles.length) {
          // Remove from our tracked array
          allSelectedFiles.splice(index, 1);

          // Update the file input
          updateFileInputWithAllFiles();

          // Update the display
          displaySelectedFiles();
        }
      }

      function validateFilesBeforeSubmit() {
        if (allSelectedFiles.length === 0) {
          return { valid: true, message: '' };
        }

        // Calculate total size of all files
        let totalSize = 0;
        const invalidFormatFiles = [];

        Array.from(allSelectedFiles).forEach((file) => {
          totalSize += file.size;

          // Check file format if settings are loaded
          if (fileSettingsLoaded && ALLOWED_FILE_FORMATS.length > 0) {
            const fileExt = getFileExtension(file.name);
            if (!ALLOWED_FILE_FORMATS.includes(fileExt)) {
              invalidFormatFiles.push(file.name);
            }
          }
        });

        // Check for invalid format files
        if (invalidFormatFiles.length > 0) {
          return {
            valid: false,
            message: `The following file(s) have invalid format: ${invalidFormatFiles.join(', ')}. Allowed formats: ${ALLOWED_FILE_FORMATS.join(', ').toUpperCase()}`
          };
        }

        // Check total size
        if (fileSettingsLoaded && totalSize > MAX_FILE_SIZE) {
          return {
            valid: false,
            message: `Total file size (${formatFileSize(totalSize)}) exceeds maximum allowed (${formatFileSize(MAX_FILE_SIZE)}). Please remove some files.`
          };
        }

        // Check file count
        if (allSelectedFiles.length > MAX_FILE_COUNT) {
          return {
            valid: false,
            message: `Maximum ${MAX_FILE_COUNT} files allowed. You have ${allSelectedFiles.length} files.`
          };
        }

        return { valid: true, message: '' };
      }

      // ================= DRAG & DROP FUNCTIONALITY =================
      function setupDragAndDrop() {
        const uploadBox = document.querySelector(".upload-box");

        uploadBox.addEventListener("dragover", (e) => {
          e.preventDefault();
          uploadBox.classList.add("drag-over");
        });

        uploadBox.addEventListener("dragleave", (e) => {
          e.preventDefault();
          uploadBox.classList.remove("drag-over");
        });

        uploadBox.addEventListener("drop", (e) => {
          e.preventDefault();
          uploadBox.classList.remove("drag-over");

          const newFiles = Array.from(e.dataTransfer.files);

          // Check if adding new files would exceed count limit
          const totalFilesAfterAdd = allSelectedFiles.length + newFiles.length;
          if (totalFilesAfterAdd > MAX_FILE_COUNT) {
            showFileValidationError(
              `Cannot add files. Maximum ${MAX_FILE_COUNT} files allowed. You would have ${totalFilesAfterAdd} files.`
            );
            return;
          }

          // Check for invalid format files first
          const invalidFormatFiles = [];
          newFiles.forEach((file) => {
            const fileExt = getFileExtension(file.name);
            if (fileSettingsLoaded && ALLOWED_FILE_FORMATS.length > 0 && !ALLOWED_FILE_FORMATS.includes(fileExt)) {
              invalidFormatFiles.push(file.name);
            }
          });

          // Show error for invalid format files and don't add them
          if (invalidFormatFiles.length > 0) {
            showFileValidationError(
              `${invalidFormatFiles.length} file(s) have invalid format and were not added. Allowed formats: ${ALLOWED_FILE_FORMATS.join(', ').toUpperCase()}`
            );
            return;
          }

          // Add all new valid-format files to our tracked list
          newFiles.forEach((newFile) => {
            // Check if file already exists
            const isDuplicate = allSelectedFiles.some(
              (existingFile) =>
                existingFile.name === newFile.name &&
                existingFile.size === newFile.size &&
                existingFile.lastModified === newFile.lastModified
            );

            if (!isDuplicate) {
              allSelectedFiles.push(newFile);
            }
          });

          // Update the file input
          updateFileInputWithAllFiles();

          // Trigger display update (validation will be shown in displaySelectedFiles)
          displaySelectedFiles();
        });
      }

      // ================= MODAL FUNCTIONS =================
      function showModal(type, title, message, onClose) {
        const modal = document.getElementById("modal");
        const modalContent = modal.querySelector('.modal-content');

        // Always use standard modal layout
        modalContent.className = 'modal-content';

        const modalIcon = document.getElementById("modalIcon");
        const modalTitle = document.getElementById("modalTitle");
        const modalMessage = document.getElementById("modalMessage");

        // Reset to standard layout if it was changed
        if (!modalIcon) {
          modalContent.innerHTML = `
            <div id="modalIcon" class="modal-icon"></div>
            <div id="modalTitle" class="modal-title"></div>
            <div id="modalMessage" class="modal-message"></div>
            <button class="modal-btn" onclick="closeModal()">OK</button>
          `;
        }

        const icon = document.getElementById('modalIcon');
        const titleEl = document.getElementById('modalTitle');
        const messageEl = document.getElementById('modalMessage');

        if (type === 'success') {
          icon.innerHTML = '<img src="assets/Success.png" class="modal-image" alt="Success" />';
          icon.className = '';
        } else if (type === 'crs-not-found') {
          icon.innerHTML = '<img src="assets/NotFound.png" class="modal-image" alt="Not Found" />';
          icon.className = '';
        } else {
          icon.innerHTML = '‚úï';
          icon.className = 'modal-icon error';
        }

        titleEl.textContent = title;
        messageEl.textContent = message;
        modal.className = "modal-overlay show";

        window.modalOnClose = onClose;
      }

      function closeModal() {
        const modal = document.getElementById("modal");
        modal.className = "modal-overlay";

        if (window.modalOnClose) {
          window.modalOnClose();
          window.modalOnClose = null;
        }
      }

      // ================= LOADING FUNCTIONS =================
      function showLoading(text, stage) {
        const loadingModal = document.getElementById("loadingModal");
        const loadingText = document.getElementById("loadingText");
        const verifyingIcon = document.getElementById("verifyingIcon");
        const separator = document.getElementById("separator");
        const preparingIcon = document.getElementById("preparingIcon");

        loadingText.textContent = text;

        // Reset to initial state
        verifyingIcon.src = 'assets/VerifyingSalesOrder.png';
        separator.src = 'assets/SeparatorGrey.png';
        preparingIcon.src = 'assets/PreparingSubmissionGrey.png';

        loadingModal.className = "loading-overlay show";
      }

      function updateLoading(text, stage) {
        const loadingText = document.getElementById("loadingText");
        const verifyingIcon = document.getElementById("verifyingIcon");
        const separator = document.getElementById("separator");
        const preparingIcon = document.getElementById("preparingIcon");

        loadingText.textContent = text;

        // Update icons based on stage
        if (stage === 'verifying') {
          verifyingIcon.src = 'assets/VerifyingSalesOrder.png';
          separator.src = 'assets/SeparatorGrey.png';
          preparingIcon.src = 'assets/PreparingSubmissionGrey.png';
        } else if (stage === 'verified') {
          verifyingIcon.src = 'assets/VerifyingSalesOrder.png';
          separator.src = 'assets/SeparatorBlue.png';
          preparingIcon.src = 'assets/PreparingSubmissionGrey.png';
        } else if (stage === 'preparing') {
          verifyingIcon.src = 'assets/VerifyingSalesOrder.png';
          separator.src = 'assets/SeparatorBlue.png';
          preparingIcon.src = 'assets/PreparingSubmissionGrey.png';
        } else if (stage === 'complete') {
          verifyingIcon.src = 'assets/VerifyingSalesOrder.png';
          separator.src = 'assets/SeparatorBlue.png';
          preparingIcon.src = 'assets/PreparingSubmission.png';
        }
      }

      function hideLoading() {
        const loadingModal = document.getElementById("loadingModal");
        loadingModal.className = "loading-overlay";
      }

      // ================= UTILITY FUNCTIONS =================
      function extractSO(value) {
        const match = value.match(/SO-\d+/i);
        return match ? match[0].toUpperCase() : null;
      }

      // Convert HTML5 date input (YYYY-MM-DD) to Salesforce format (YYYY-MM-DD)
      function formatDateForSalesforce(dateString) {
        if (!dateString) return null;

        // HTML5 date input already returns YYYY-MM-DD
        // Validate format
        const datePattern = /^\d{4}-\d{2}-\d{2}$/;
        if (datePattern.test(dateString)) {
          return dateString;
        }

        // If somehow not in correct format, try to parse
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
          console.warn("Invalid date:", dateString);
          return null;
        }

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");

        return `${year}-${month}-${day}`;
      }

      // Calculate days between date and today
      function calculateDaysFromToday(dateString) {
        if (!dateString) return "0";

        const date = new Date(dateString);
        if (isNaN(date.getTime())) return "0";

        const today = new Date();

        // Reset time components for accurate day calculation
        date.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);

        const diffTime = today.getTime() - date.getTime();
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        // Ensure non-negative value
        return diffDays >= 0 ? diffDays.toString() : "0";
      }

      // ================= DATE CALCULATION SETUP =================
      function setupDateCalculations() {
        const installDateInput = document.getElementById("installDate");
        const removalDateInput = document.getElementById("removalDate");
        const totalTimeInput = document.getElementById("totalTimeSinceInstall");
        const totalCyclesInput = document.getElementById(
          "totalCyclesSinceInstall"
        );

        // Calculate days when install date changes
        installDateInput.addEventListener("change", function () {
          if (this.value) {
            const days = calculateDaysFromToday(this.value);
            totalTimeInput.value = days;

            // Validate install date is not in the future
            const installDate = new Date(this.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (installDate > today) {
              showModal(
                "error",
                "Invalid Date",
                "Install Date cannot be in the future."
              );
              this.value = "";
              totalTimeInput.value = "";
              this.focus();
            }
          } else {
            totalTimeInput.value = "";
            if (!removalDateInput.value) {
              totalCyclesInput.value = "";
            }
          }
        });

        // Calculate days when removal date changes
        removalDateInput.addEventListener("change", function () {
          if (this.value) {
            const days = calculateDaysFromToday(this.value);
            totalCyclesInput.value = days;

            // Validate removal date is not in the future
            const removalDate = new Date(this.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (removalDate > today) {
              showModal(
                "error",
                "Invalid Date",
                "Removal Date cannot be in the future."
              );
              this.value = "";
              totalCyclesInput.value = "";
              this.focus();
            }

            // Validate removal date is not before install date
            if (installDateInput.value) {
              const installDate = new Date(installDateInput.value);
              if (removalDate < installDate) {
                showModal(
                  "error",
                  "Invalid Date",
                  "Removal Date cannot be before Install Date."
                );
                this.value = "";
                totalCyclesInput.value = "";
                this.focus();
              }
            }
          } else {
            totalCyclesInput.value = "";
            // If removal date is cleared, use install date for cycles
            if (installDateInput.value) {
              totalCyclesInput.value = calculateDaysFromToday(
                installDateInput.value
              );
            }
          }
        });

        // Set max date to today for all date inputs
        function setMaxDateToToday() {
          const today = new Date().toISOString().split("T")[0];

          const dateInputs = [
            document.getElementById("installDate"),
            document.getElementById("removalDate"),
            document.getElementById("originalTransactionDate"),
          ];

          dateInputs.forEach((input) => {
            if (input) {
              input.max = today;
            }
          });
        }

        setMaxDateToToday();
      }

      // ================= SALESFORCE API FUNCTIONS =================
      async function getAccessToken() {
        const params = new URLSearchParams();
        params.append("grant_type", "client_credentials");
        params.append("client_id", CLIENT_ID);
        params.append("client_secret", CLIENT_SECRET);

        const response = await fetch(OAUTH_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
        });

        if (!response.ok) {
          throw new Error("Failed to authenticate with Salesforce");
        }

        const data = await response.json();
        return data.access_token;
      }

      async function verifySalesOrder(salesOrderNumber, customerPoNumber, accessToken) {
        // Build query parameters based on the logic:
        // 1. If both are provided, only check SO #
        // 2. If only SO # is provided, check SO #
        // 3. If only Customer PO # is provided, check Customer PO #

        let queryParams = [];

        if (salesOrderNumber) {
          // If SO # is provided (with or without Customer PO), only check SO #
          queryParams.push("salesOrderNumber=" + encodeURIComponent(salesOrderNumber));
        } else if (customerPoNumber) {
          // If only Customer PO # is provided (no SO #), check Customer PO #
          queryParams.push("customerPoNumber=" + encodeURIComponent(customerPoNumber));
        }

        const url = API_ENDPOINT + "?" + queryParams.join("&");

        const response = await fetch(url, {
          method: "GET",
          headers: {
            Authorization: "Bearer " + accessToken,
            "Content-Type": "application/json",
          },
        });

        if (!response.ok) {
          throw new Error("Failed to verify order");
        }

        return await response.json();
      }

      async function getRecordTypeId(accessToken) {
        const query =
          "SELECT Id FROM RecordType WHERE SobjectType='Case' AND DeveloperName='Sales' LIMIT 1";
        const url =
          SF_INSTANCE +
          "/services/data/v62.0/query?q=" +
          encodeURIComponent(query);

        const response = await fetch(url, {
          method: "GET",
          headers: {
            Authorization: "Bearer " + accessToken,
            "Content-Type": "application/json",
          },
        });

        if (!response.ok) {
          throw new Error("Failed to query Record Type");
        }

        const data = await response.json();
        if (data.records && data.records.length > 0) {
          return data.records[0].Id;
        } else {
          throw new Error("Sales Record Type not found");
        }
      }

      async function createCase(formData, accessToken) {
        // Prepare data for Salesforce
        // Build subject based on what's available
        let subject = "RMA Request";
        if (formData.salesOrderNumber && formData.customerPoNumber) {
          subject = `RMA Request - ${formData.salesOrderNumber} / ${formData.customerPoNumber}`;
        } else if (formData.salesOrderNumber) {
          subject = `RMA Request - ${formData.salesOrderNumber}`;
        } else if (formData.customerPoNumber) {
          subject = `RMA Request - ${formData.customerPoNumber}`;
        }

        const caseData = {
          // Required fields
          Subject: subject,
          SuppliedCompany: formData.companyName,
          SuppliedName: formData.contactName,
          SuppliedEmail: formData.email,
          SuppliedPhone: formData.phone,
          Status: "New",
          Type: "Sales",
          Origin: "Web",
          RecordTypeId: formData.recordTypeId,

          // Custom fields with proper date formatting
          Customer_Name__c: formData.customerNumber || null,
          Customer_PO__c: formData.customerPoNumber,
          Category__c: formData.rmaRequestType,
          Part_Number__c: formData.partNumber,
          Serial_Number__c: formData.serialNumber,
          Aircraft_Type__c: formData.aircraftType,
          Aircraft_Serial__c: formData.aircraftSerialNumber,

          // Date fields formatted for Salesforce
          Original_Transaction_Date__c: formatDateForSalesforce(
            formData.originalTransactionDate
          ),
          Original_Invoice__c: formData.originalInvoiceNumber || null,
          Install_Date__c: formatDateForSalesforce(formData.installDate),
          Removal_Date__c: formatDateForSalesforce(formData.removalDate),

          // Calculated fields
          Total_time_since_install_of_part__c:
            formData.totalTimeSinceInstall || "0",
          Total_cycle_since_install_of_part__c:
            formData.totalCyclesSinceInstall || "0",
          Discrepancy__c: formData.discrepancy,
          Sub_Type__c: "RMA",
        };

        // Remove null values to avoid sending empty fields
        Object.keys(caseData).forEach((key) => {
          if (caseData[key] === null || caseData[key] === undefined) {
            delete caseData[key];
          }
        });

        console.log(
          "Creating Case with data:",
          JSON.stringify(caseData, null, 2)
        );

        const response = await fetch(
          SF_INSTANCE + "/services/data/v62.0/sobjects/Case",
          {
            method: "POST",
            headers: {
              Authorization: "Bearer " + accessToken,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(caseData),
          }
        );

        if (!response.ok) {
          const errorText = await response.text();
          console.error("Case creation error response:", errorText);
          throw new Error("Failed to create case: " + response.status);
        }

        const result = await response.json();
        return result.id;
      }

      async function uploadFile(file, caseId, accessToken) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = async function (e) {
            const base64Content = btoa(
              new Uint8Array(e.target.result).reduce(
                (data, byte) => data + String.fromCharCode(byte),
                ""
              )
            );

            const contentVersionData = {
              Title: file.name,
              PathOnClient: file.name,
              VersionData: base64Content,
              FirstPublishLocationId: caseId,
            };

            try {
              const response = await fetch(
                SF_INSTANCE + "/services/data/v62.0/sobjects/ContentVersion",
                {
                  method: "POST",
                  headers: {
                    Authorization: "Bearer " + accessToken,
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(contentVersionData),
                }
              );

              if (!response.ok) {
                throw new Error("Failed to upload file: " + file.name);
              }

              resolve();
            } catch (error) {
              reject(error);
            }
          };

          reader.onerror = function () {
            reject(new Error("Failed to read file: " + file.name));
          };

          reader.readAsArrayBuffer(file);
        });
      }

      // ================= FORM SUBMISSION =================
      async function handleFormSubmit(event) {
        event.preventDefault();

        const form = event.target;
        const submitBtn = document.getElementById("submitBtn");
        const fileInput = document.getElementById("fileAttachment");

        // Basic validation
        const requiredFields = form.querySelectorAll("[required]");
        let isValid = true;
        let firstInvalidField = null;

        requiredFields.forEach((field) => {
          if (!field.value.trim()) {
            isValid = false;
            if (!firstInvalidField) firstInvalidField = field;
            field.style.border = "1px solid #d93025";
          } else {
            field.style.border = "1px solid #d0d7e5";
          }
        });

        if (!isValid) {
          showModal(
            "error",
            "Missing Fields",
            "Please fill in all required fields."
          );
          if (firstInvalidField) firstInvalidField.focus();
          return;
        }

        // Validate email format
        const emailField = form.querySelector('[name="email"]');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailField.value && !emailRegex.test(emailField.value)) {
          showModal(
            "error",
            "Invalid Email",
            "Please enter a valid email address."
          );
          emailField.focus();
          return;
        }

        // Validate files before proceeding
        const fileValidation = validateFilesBeforeSubmit();
        if (!fileValidation.valid) {
          showModal("error", "File Upload Error", fileValidation.message);
          return;
        }

        // Extract SO number and Customer PO number
        const salesOrderField = form.querySelector('[name="salesOrderNumber"]');
        const customerPoField = form.querySelector('[name="customerPoNumber"]');
        const salesOrderNumber = extractSO(salesOrderField.value);
        const customerPoNumber = customerPoField.value.trim();

        // At least one of SO # or Customer PO # must be provided
        if (!salesOrderNumber && !customerPoNumber) {
          showModal(
            "error",
            "Missing Required Field",
            "Please enter either Sales Order Number (SO-XXXXX) or Customer PO Number."
          );
          salesOrderField.focus();
          return;
        }

        // If SO # is provided, validate format
        if (salesOrderField.value.trim() && !salesOrderNumber) {
          showModal(
            "error",
            "Invalid Format",
            "Sales Order Number must be in format SO-XXXXX"
          );
          salesOrderField.focus();
          return;
        }

        // Validate dates are not in the future
        const installDateInput = document.getElementById("installDate");
        const today = new Date().toISOString().split("T")[0];

        if (installDateInput.value && installDateInput.value > today) {
          showModal(
            "error",
            "Invalid Date",
            "Install Date cannot be in the future."
          );
          installDateInput.focus();
          return;
        }

        const removalDateInput = document.getElementById("removalDate");
        if (removalDateInput.value && removalDateInput.value > today) {
          showModal(
            "error",
            "Invalid Date",
            "Removal Date cannot be in the future."
          );
          removalDateInput.focus();
          return;
        }

        // Validate removal date is not before install date
        if (installDateInput.value && removalDateInput.value) {
          if (removalDateInput.value < installDateInput.value) {
            showModal(
              "error",
              "Invalid Date",
              "Removal Date cannot be before Install Date."
            );
            removalDateInput.focus();
            return;
          }
        }

        // Disable submit button and show loading
        submitBtn.disabled = true;
        // Determine loading message based on what will be validated
        // If SO # is provided (with or without Customer PO), we validate SO #
        // If only Customer PO # is provided, we validate Customer PO #
        const loadingMessage = salesOrderNumber
          ? "Verifying Sales Order..."
          : "Verifying Customer PO...";
        showLoading(loadingMessage, "verifying");

        try {
          // Step 1: Get access token
          const accessToken = await getAccessToken();
          updateLoading(loadingMessage, "verifying");

          // Step 2: Verify Sales Order or Customer PO based on logic
          const verificationResult = await verifySalesOrder(
            salesOrderNumber,
            customerPoNumber,
            accessToken
          );

          if (!verificationResult.salesOrderExists) {
            hideLoading();

            // Determine error message based on what was validated
            let errorTitle = "CRS Order Not found";
            let errorMessage = "";

            if (salesOrderNumber) {
              // If SO # was provided (with or without Customer PO), SO # was validated
              errorMessage = "Sales Order number entered does not match our records";
            } else {
              // If only Customer PO # was provided, Customer PO was validated
              errorMessage = "Customer PO Number entered does not match our records";
            }

            showModal(
              "crs-not-found",
              errorTitle,
              errorMessage
            );
            submitBtn.disabled = false;
            return;
          }

          const verifiedMessage = salesOrderNumber
            ? "Sales Order Verified"
            : "Customer PO Verified";
          updateLoading(verifiedMessage, "verified");

          // Step 3: Get Record Type ID
          updateLoading("Preparing Submission...", "preparing");
          const recordTypeId = await getRecordTypeId(accessToken);

          // Step 4: Prepare form data
          const formData = {
            companyName: form
              .querySelector('[name="companyName"]')
              .value.trim(),
            contactName: form
              .querySelector('[name="contactName"]')
              .value.trim(),
            rmaRequestType: form.querySelector('[name="rmaRequestType"]').value,
            email: form.querySelector('[name="email"]').value.trim(),
            customerNumber: form
              .querySelector('[name="customerNumber"]')
              .value.trim(),
            phone: form.querySelector('[name="phone"]').value.trim(),
            salesOrderNumber: salesOrderNumber || null,
            customerPoNumber: customerPoNumber || null,
            originalTransactionDate: form.querySelector(
              '[name="originalTransactionDate"]'
            ).value,
            originalInvoiceNumber: form
              .querySelector('[name="originalInvoiceNumber"]')
              .value.trim(),
            partNumber: form.querySelector('[name="partNumber"]').value.trim(),
            aircraftType: form
              .querySelector('[name="aircraftType"]')
              .value.trim(),
            serialNumber: form
              .querySelector('[name="serialNumber"]')
              .value.trim(),
            aircraftSerialNumber: form
              .querySelector('[name="aircraftSerialNumber"]')
              .value.trim(),
            installDate: form.querySelector('[name="installDate"]').value,
            totalTimeSinceInstall:
              form
                .querySelector('[name="totalTimeSinceInstall"]')
                .value.trim() || "0",
            removalDate: form.querySelector('[name="removalDate"]').value,
            totalCyclesSinceInstall:
              form
                .querySelector('[name="totalCyclesSinceInstall"]')
                .value.trim() || "0",
            discrepancy: form
              .querySelector('[name="discrepancy"]')
              .value.trim(),
            recordTypeId: recordTypeId,
          };

          console.log("Form data prepared for submission:", formData);

          // Step 5: Create Case
          updateLoading("Creating Case in Salesforce...", "preparing");
          const caseId = await createCase(formData, accessToken);

          // Step 6: Upload files if any
          if (allSelectedFiles.length > 0) {
            updateLoading(`Uploading Files...`, "preparing");

            for (let i = 0; i < allSelectedFiles.length; i++) {
              updateLoading(
                `Uploading file ${i + 1} of ${allSelectedFiles.length}...`,
                "preparing"
              );

              try {
                await uploadFile(allSelectedFiles[i], caseId, accessToken);
              } catch (fileError) {
                console.warn(
                  `Failed to upload file: ${allSelectedFiles[i].name}`,
                  fileError
                );
                // Continue with other files even if one fails
              }
            }
          }

          // Step 7: Complete
          updateLoading("Submission Complete", "complete");
          setTimeout(() => {
            hideLoading();
            showModal(
              "success",
              "Form Successfully Submitted",
              "",
              function () {
                // Reset form
                form.reset();
                // Reset calculated fields
                document.getElementById("totalTimeSinceInstall").value = "";
                document.getElementById("totalCyclesSinceInstall").value = "";
                // Clear all selected files
                allSelectedFiles = [];
                updateFileInputWithAllFiles();
                displaySelectedFiles();
              }
            );
            submitBtn.disabled = false;
          }, 1000);
        } catch (error) {
          console.error("Submission error:", error);
          hideLoading();
          showModal(
            "error",
            "Submission Failed",
            "An error occurred while submitting the form. Please try again."
          );
          submitBtn.disabled = false;
        }
      }

      // ================= INITIALIZATION =================
      document.addEventListener("DOMContentLoaded", async function () {
        // Setup date calculations
        setupDateCalculations();

        // Setup form submission
        const form = document.getElementById("rmaForm");
        form.addEventListener("submit", handleFormSubmit);

        // Setup input validation styling
        const inputs = form.querySelectorAll("input, select, textarea");
        inputs.forEach((input) => {
          input.addEventListener("input", function () {
            this.style.border = "1px solid #d0d7e5";
          });
        });

        // Setup file upload functionality
        const fileInput = document.getElementById("fileAttachment");

        fileInput.addEventListener("change", function (e) {
          // Get the newly selected files
          const newFiles = Array.from(e.target.files);

          if (newFiles.length === 0) {
            return; // User canceled the file selection
          }

          // Check if adding new files would exceed count limit
          const totalFilesAfterAdd = allSelectedFiles.length + newFiles.length;
          if (totalFilesAfterAdd > MAX_FILE_COUNT) {
            showFileValidationError(
              `Cannot add files. Maximum ${MAX_FILE_COUNT} files allowed. You would have ${totalFilesAfterAdd} files.`
            );
            return;
          }

          // Check for invalid format files first
          const invalidFormatFiles = [];
          newFiles.forEach((file) => {
            const fileExt = getFileExtension(file.name);
            if (fileSettingsLoaded && ALLOWED_FILE_FORMATS.length > 0 && !ALLOWED_FILE_FORMATS.includes(fileExt)) {
              invalidFormatFiles.push(file.name);
            }
          });

          // Show error for invalid format files and don't add them
          if (invalidFormatFiles.length > 0) {
            showFileValidationError(
              `${invalidFormatFiles.length} file(s) have invalid format and were not added. Allowed formats: ${ALLOWED_FILE_FORMATS.join(', ').toUpperCase()}`
            );
            return;
          }

          // Add all new valid-format files to our tracked list
          newFiles.forEach((newFile) => {
            // Check if file already exists (by name, size, and lastModified)
            const isDuplicate = allSelectedFiles.some(
              (existingFile) =>
                existingFile.name === newFile.name &&
                existingFile.size === newFile.size &&
                existingFile.lastModified === newFile.lastModified
            );

            if (!isDuplicate) {
              allSelectedFiles.push(newFile);
            }
          });

          // Update the file input with all files
          updateFileInputWithAllFiles();

          // Display the updated file list (validation will be shown in displaySelectedFiles)
          displaySelectedFiles();
        });

        setupDragAndDrop();

        // Load attachment settings dynamically
        try {
          await fetchFileSettings();
        } catch (error) {
          console.error("Failed to load attachment settings:", error);
          // Continue with defaults
        }
      });
    </script>
  </body>
</html>
